# test the multi-app-package example
cd examples/multi-app-package

exec cue cmd dump ./apps/...
cmp stdout $WORK/golden.yaml

-- golden.yaml --
apiVersion: v1
kind: ConfigMap
metadata:
  name: foobar
  namespace: default
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
data:
  FOO: BAR
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: first
  namespace: default
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: first
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: foobar
      app.kubernetes.io/component: first
  template:
    metadata:
      labels:
        app.kubernetes.io/name: foobar
        app.kubernetes.io/component: first
      annotations:
        config/foobar/checksum: bW+slY5Hn17Ai0wSD6V7fTGSj8XnQ5+T1wGIqr0A2Pg=
    spec:
      containers:
        - name: main
          image: foobar:latest
          ports:
            - name: http
              containerPort: 5050
              protocol: TCP
          envFrom:
            - secretRef:
                name: foo-secret
          env:
            - name: TZ
              value: Australia/Sydney
          imagePullPolicy: Always
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: foo-third
  namespace: default
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: foo-third
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: foobar
      app.kubernetes.io/component: foo-third
  template:
    metadata:
      labels:
        app.kubernetes.io/name: foobar
        app.kubernetes.io/component: foo-third
    spec:
      volumes:
        - emptyDir: {}
          name: data
      containers:
        - name: main
          image: third:1.0.0
          env:
            - name: ENVIRONMENT
              value: staging
            - name: TZ
              value: Australia/Sydney
          volumeMounts:
            - mountPath: /data
              name: data
---
apiVersion: v1
kind: Service
metadata:
  name: first
  namespace: default
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: first
spec:
  ports:
    - name: http
      port: 5050
      protocol: TCP
      targetPort: 5050
  selector:
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: first
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: foo-sts
  namespace: sts
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: foo-sts
spec:
  ports:
    - name: http
      port: 6060
      protocol: TCP
      targetPort: 6060
      nodePort: 30000
  selector:
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: foo-sts
  type: NodePort
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: foo-sts
  namespace: sts
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: foo-sts
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: foobar
      app.kubernetes.io/component: foo-sts
  template:
    metadata:
      labels:
        app.kubernetes.io/name: foobar
        app.kubernetes.io/component: foo-sts
    spec:
      containers:
        - name: main
          image: second:latest
          ports:
            - name: http
              containerPort: 6060
              protocol: TCP
          env:
            - name: TZ
              value: Australia/Sydney
          imagePullPolicy: Always
  serviceName: foo-sts
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: foo-cronjob
  namespace: default
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: foo-cronjob
spec:
  schedule: '*/15 * * * *'
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: foobar
            app.kubernetes.io/component: foo-cronjob
        spec:
          containers:
            - name: main
              image: cronjob:v1
              env:
                - name: TZ
                  value: Australia/Sydney
---
apiVersion: batch/v1
kind: Job
metadata:
  name: foo-job
  namespace: default
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
    app.kubernetes.io/component: foo-job
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: foobar
        app.kubernetes.io/component: foo-job
    spec:
      containers:
        - name: main
          image: job:v1
          env:
            - name: TZ
              value: Australia/Sydney
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: foo-pvc
  namespace: default
  labels:
    TEST: TEST_BAR
    app.kubernetes.io/name: foobar
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10gb
  storageClassName: local

